# PQ动态获取相对路径

尽管PQ非常灵活，但仍然存在一些不太方便的地方，比如文件路径为绝对路径，无法动态刷新，做好的报告发给同事后必须修改路径才能刷新。但是Excel工作表函数能做到。本文结合Excel功能实现PQ动态获取相对路径。

## 工作表函数

首先我们打开报告，新建一个sheet，先来测试一下，在任一单元格输入`=CELL("filename")`，返回了当前文件的动态路径，例如C:\Users\Admin\Desktop\[test.xlsx]Sheet1，如果我们把文件换个路径存放或者发给同事，返回的结果也会跟着变化，我们要的正是这个效果。

## 构建路径表

然后开始构建路径表，新建两列，一列手动输入源文件的文件名，另一列输入公式`=LEFT(CELL("filename"),FIND("[",CELL("filename"))-1)&A2&".xlsx"`，返回C:\Users\Admin\Desktop\表1.xlsx。公式中&右边的部分根据实际情况自行修改，就是用left+find截取cell返回的左边部分，然后&自己的文件路径，很简单我就不详细介绍了，公式输完看下结果是否为正确的路径。

![path1](../_media/path1.jpg)

## 导入PQ

路径表做好后，将其导入PQ，创建一个新的查询为"路径表"，当然名字你可以随便起，那么其他表的路径只需要深化出"路径表"中对应的路径，即为相对路径。比如常规导入excel文件生成的公式为`= Excel.Workbook(File.Contents("C:\Users\Admin\Desktop\表3.xlsx"), null, true)`
那么我们只需要把绝对路径替换为"路径表"中对应的相对路径即可，"表3"的路径在"路径表"中[路径]字段下的第3行，也就是`路径表[路径]{2}`，替换得到`= Excel.Workbook(File.Contents(路径表[路径]{2}), null, true)`

![path2](../_media/path2.jpg)

看下返回的结果是不是和替换前一摸一样？至此动态获取相对路径完成。

需要注意的是，创建路径表有两种方式：
1、路径表随报告文件
即路径表和报告在同一个文件中，这样可以通过数据-从表格将路径表导入，优点是能实现真正的全动态相对路径，转移路径无需修改任何参数。缺点就是只能用于Power Query for Excel。
2、路径表和报告分离
即两者不在同一个文件中，是通过新建查询-从文件-从工作簿导入的，优点是可用于Power BI Desktop。缺点是无法动态获取路径表本身的路径，转移路径需要更改路径表的路径，不过也仅需要改这一个路径，其他源文件的路径即可通过路径表获取，比起改全部路径还是方便很多。
请根据自身情况选择。

如出现以下错误，点击文件-文件和设置-查询选项，把隐私设置为始终忽略即可。

![error](../_media/error.png)
